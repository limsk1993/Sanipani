<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
   <sqlMap namespace="AuctionBoard">
   
		<select id="getAuction"
				parameterClass="java.util.HashMap"
				resultClass="java.util.HashMap">
      			SELECT A.AUCTIONWORDNO, A.AUCTIONPRODUCTNAME, WORDTITLE, WORDCONTENT, RNOWBUYPAY,
      				   MAX(BIDPRICE) AS BIDPRICE, STARTBUYPAY, WRITERDATE, ENDDATE, LOOKUP, PICTURENAME, A.NICK, A.MEMBERNO
				FROM (SELECT ROW_NUMBER() OVER(ORDER BY AB.AUCTIONWORDNO DESC) AS RNUM, 
							 AB.AUCTIONWORDNO, AB.AUCTIONPRODUCTNAME, AB.WORDTITLE, AB.WORDCONTENT,
							 AB.RNOWBUYPAY, AC.BIDPRICE, AB.STARTBUYPAY, to_char(AB.WRITERDATE, 'YYYY-MM-DD') AS WRITERDATE,
							 to_char(AB.ENDDATE, 'YYYY-MM-DD') AS ENDDATE, AB.LOOKUP, AP.PICTURENAME, MI.NICK, AC.AUCTIONNO, AB.MEMBERNO
				      FROM AUCTIONBOARD AB LEFT OUTER JOIN AUCTIONPICTURE AP ON AB.AUCTIONWORDNO = AP.AUCTIONWORDNO
				                           LEFT OUTER JOIN MEMBERINFO MI ON AB.MEMBERNO = MI.MEMBERNO
				                           LEFT OUTER JOIN AUCTION AC ON AB.AUCTIONWORDNO = AC.AUCTIONWORDNO
				      WHERE 1 = 1
				      AND AUCTIONDEL = 1 
					  <isNotEmpty property="searchText">
						 AND AUCTIONPRODUCTNAME LIKE '%' || #searchText# || '%'
					  </isNotEmpty>
				      ) A
				WHERE A.RNUM BETWEEN #start# AND #end#
				GROUP BY A.AUCTIONWORDNO, A.AUCTIONPRODUCTNAME, WORDTITLE, WORDCONTENT, RNOWBUYPAY, STARTBUYPAY, WRITERDATE, ENDDATE, LOOKUP, PICTURENAME, A.NICK, A.MEMBERNO
				ORDER BY A.AUCTIONWORDNO DESC
		</select>
		
		<select id="getAuctionCount"
				parameterClass="java.util.HashMap"
				resultClass="Integer">
			SELECT COUNT(*) AS CNT
			FROM AUCTIONBOARD
			WHERE 1 = 1
			<isNotEmpty property="searchText">
				AND AUCTIONPRODUCTNAME LIKE '%' || #searchText# || '%'
			</isNotEmpty>
		</select>
		
		<insert id="insertAuction"
				parameterClass="java.util.HashMap"> 
			INSERT INTO AUCTIONBOARD(AUCTIONWORDNO, AUCTIONPRODUCTNAME, WORDTITLE, WORDCONTENT, RNOWBUYPAY, NOWBUYPAY, STARTBUYPAY, WRITERDATE, ENDDATE, LOOKUP, MEMBERNO, AUCTIONDEL, AUCTIONBOARDSTATUS)
			VALUES(AUCTIONBOARD_SEQ.NEXTVAL, #AuctionproductName#, #Auctiontitle#, #AuctionContents#, #NowAuctionPrice#, #StartAuctionPrice#, #StartAuctionPrice#, SYSDATE, SYSDATE + 5, '0', #UserNo#, '1', 0)
		</insert>
		
		<update id="deleteAuction"
				parameterClass="java.util.HashMap">
			UPDATE AUCTIONBOARD
			SET AUCTIONDEL = 0
			WHERE AUCTIONWORDNO = #auctionNo#
		</update>
		
		<select id="getAuctionCon"
				parameterClass="java.util.HashMap"
				resultClass="java.util.HashMap">
			SELECT AB.AUCTIONWORDNO, AUCTIONPRODUCTNAME, WORDTITLE, WORDCONTENT, RNOWBUYPAY, MAX(AC.BIDPRICE) AS BIDPRICE, STARTBUYPAY, WRITERDATE, ENDDATE, 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 2, 9)) || '일 ' || 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 12, 2)) || '시간 ' || 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 15, 2)) || '분 '|| 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 18, 2)) || '초 ' REMAINTIME, 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 2, 9)) AS "DAY",
               	   TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 12, 2)) AS "HOUR",
                   TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 15, 2)) AS "MIN",
                   TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 18, 2)) AS "SEC",
                   NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY') AS "REALTIME" ,
		           LOOKUP, PICTURENAME, PICTURENAME1, PICTURENAME2, PICTURENAME3, PICTURENAME4, MI.NICK, AB.MEMBERNO, AUCTIONBOARDSTATUS, AC.AUCTIONSTATUS, AC.MEMBERNO AS AUCTIONMEMBERNO
			FROM AUCTIONBOARD AB LEFT OUTER JOIN AUCTIONPICTURE AP ON AB.AUCTIONWORDNO = AP.AUCTIONWORDNO
                           		 FULL OUTER JOIN MEMBERINFO MI ON AB.MEMBERNO = MI.MEMBERNO
                           		 LEFT OUTER JOIN AUCTION AC ON AB.AUCTIONWORDNO = AC.AUCTIONWORDNO
			WHERE AB.AUCTIONWORDNO = #auctionNo#
				<isNotEmpty property="BidPrice">
					AND AC.BIDPRICE IN (SELECT MAX(BIDPRICE) FROM AUCTION WHERE AUCTIONWORDNO = #auctionNo#)
				</isNotEmpty>
			GROUP BY AB.AUCTIONWORDNO, AUCTIONPRODUCTNAME, WORDTITLE, WORDCONTENT, RNOWBUYPAY, STARTBUYPAY, WRITERDATE,
					 ENDDATE, LOOKUP, PICTURENAME, PICTURENAME1, PICTURENAME2, PICTURENAME3, PICTURENAME4, MI.NICK, AB.MEMBERNO, AUCTIONBOARDSTATUS, AC.AUCTIONSTATUS, AC.MEMBERNO
					 
			<!-- 대체 쿼리 -->
			<!-- SELECT AB.AUCTIONWORDNO, AUCTIONPRODUCTNAME, WORDTITLE, WORDCONTENT, RNOWBUYPAY, NVL(AC.BIDPRICE, 0) AS BIDPRICE, STARTBUYPAY, WRITERDATE, ENDDATE, 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 2, 9)) || '일 ' || 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 12, 2)) || '시간 ' || 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 15, 2)) || '분 '|| 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 18, 2)) || '초 ' REMAINTIME, 
		           TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 2, 9)) AS "DAY",
               	   TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 12, 2)) AS "HOUR",
                   TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 15, 2)) AS "MIN",
                   TO_NUMBER (SUBSTR (NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY'), 18, 2)) AS "SEC",
                   NUMTODSINTERVAL(ENDDATE-SYSDATE, 'DAY') AS "REALTIME" ,
		           LOOKUP, PICTURENAME, PICTURENAME1, PICTURENAME2, PICTURENAME3, PICTURENAME4, MI.NICK, AB.MEMBERNO, AUCTIONBOARDSTATUS, AC.AUCTIONSTATUS, AC.MEMBERNO AS AUCTIONMEMBERNO
			FROM AUCTIONBOARD AB LEFT OUTER JOIN AUCTIONPICTURE AP ON AB.AUCTIONWORDNO = AP.AUCTIONWORDNO
                           		 INNER JOIN MEMBERINFO MI ON AB.MEMBERNO = MI.MEMBERNO
                           		 LEFT OUTER JOIN (SELECT AUCTIONWORDNO, ROW_NUMBER() OVER(PARTITION BY AUCTIONWORDNO ORDER BY BIDPRICE DESC) AS BIDPRICE_NO, MEMBERNO, AUCTIONSTATUS, BIDPRICE
                                                FROM AUCTION) AC 
                                            ON AB.AUCTIONWORDNO = AC.AUCTIONWORDNO
                                           AND AC.BIDPRICE_NO = 1
			WHERE AB.AUCTIONWORDNO = 103 -->
		</select>
		
		<select id="getAuctionNo"
				resultClass="Integer">
			SELECT MAX(AUCTIONWORDNO)
			FROM AUCTIONBOARD
		</select>
		
		
		<insert id="insertAuctionPicture"
				parameterClass="java.util.HashMap"> 
			INSERT INTO AUCTIONPICTURE(PICTURENAME, PICTURENAME1, PICTURENAME2, PICTURENAME3, PICTURENAME4, AUCTIONWORDNO)
			VALUES(#auctionFile1#, #auctionFile2#, #auctionFile3#, #auctionFile4#, #auctionFile5#, #auctionNum#)
		</insert>
		
		<update id="updateAuction"
				parameterClass="java.util.HashMap">
			UPDATE AUCTIONBOARD
			SET AUCTIONPRODUCTNAME = #AuctionproductName#,
				WORDTITLE = #Auctiontitle#,
				STARTBUYPAY = #StartAuctionPrice#,
				RNOWBUYPAY = #NowAuctionPrice#,
				WORDCONTENT = #AuctionContents#,
				WRITERDATE = SYSDATE
			WHERE AUCTIONWORDNO = #auctionNo#
		</update>
		
		<update id="updateAuctionAddDate">
			UPDATE AUCTIONBOARD
			SET ENDDATE = ENDDATE + 0.0035
			WHERE AUCTIONWORDNO = #auctionNo#
		</update>
		
		<update id="updateAuctionEnd">
			UPDATE AUCTIONBOARD
			SET AUCTIONBOARDSTATUS = 1
			WHERE AUCTIONWORDNO = #auctionNo#
		</update>
		
		<update id="updateAuctionEnd2">
			UPDATE AUCTION
			SET AUCTIONSTATUS = 1
			WHERE AUCTIONWORDNO = #auctionNo#
			AND BIDPRICE = #BidPrice#
		</update>
		
		<insert id="updateAuctionPriceRegist"
				parameterClass="java.util.HashMap">
			INSERT INTO AUCTION (AUCTIONNO, AUCTIONWORDNO, TRADESTATUSNO, MEMBERNO, BIDPRICE, BIDDATE, ESCROWWHETHER, AUCTIONPHONE, AUCTIONADDR, AUCTIONEMAIL)
			VALUES (AUCTION_SEQ.NEXTVAL, #auctionNo#, 1, #MemberNo#, #AuctionPrice#, SYSDATE, NULL, NULL, NULL, NULL)
		</insert>
		
		<delete id="updateAuctionPriceCancel"
				parameterClass="java.util.HashMap">
			DELETE FROM AUCTION
			WHERE MEMBERNO = #MemberNo#
			AND AUCTIONWORDNO = #auctionNo#
		</delete>
		
		<update id="updateAuctionLookup"
				parameterClass="java.util.HashMap">
			UPDATE AUCTIONBOARD
			SET LOOKUP = LOOKUP + 1
			WHERE AUCTIONWORDNO = #auctionNo#
		</update>
		
   </sqlMap>